name: Terraform Plan k8s

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, closed] 
  workflow_dispatch:

env:
  # Yandex Cloud Secrets
  YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  YC_REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  YC_ACCESS_KEY: ${{ secrets.YC_ACCESS_KEY }}
  YC_SECRET_KEY: ${{ secrets.YC_SECRET_KEY }}
  
  # Terraform Variables
  TF_VAR_folder_id: ${{ secrets.YC_FOLDER_ID }}
  TF_VAR_registry_id: ${{ secrets.YC_REGISTRY_ID }}
  TF_VAR_yc_access_key: ${{ secrets.YC_ACCESS_KEY }}
  TF_VAR_yc_secret_key: ${{ secrets.YC_SECRET_KEY }}
  
  AWS_ACCESS_KEY_ID: ${{ secrets.YC_ACCESS_KEY }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.YC_SECRET_KEY }}
  
  # Work directory
  TF_K8S_DIR: "Terraform/k8s"
  TF_APPLICATION_DIR: "Terraform/application"



jobs:
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.11.0

    - name: Install YC CLI
      run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -n -i /home/runner/yc
          echo "/home/runner/yc/bin" >> $GITHUB_PATH
          chmod +x /home/runner/yc/bin/yc

    - name: Yc test
      working-directory: ${{ env.TF_K8S_DIR}} 
      run: |
        yc --version

        echo '${{ secrets.YC_SERVICE_ACCOUNT_KEY_JSON }}' > sa-key.json
        chmod 600 sa-key.json

        yc config profile create github-actions
        yc config set service-account-key sa-key.json
        yc config set folder-id  ${{ secrets.YC_FOLDER_ID }}

        yc config profile list
 

    - name: Terraform Init k8s
      working-directory: ${{ env.TF_K8S_DIR}} 
      run: terraform init 

    - name: Check and import DNS zone
      working-directory: ${{ env.TF_K8S_DIR}} 
      run: |
        # Проверяем существование зоны
        if yc dns zone list --format json | jq -e '.[] | select(.name=="stellarclaw-zone")' > /dev/null 2>&1; then
          echo "DNS zone importing"
          ZONE_ID=$(yc dns zone get --name stellarclaw-zone --format json | jq -r '.id')
          terraform import yandex_dns_zone.stellarclaw_zone $ZONE_ID || echo "Zone already managed or import failed"
        else
          echo "DNS zone does not exist, will be created"
        fi

    - name: Terraform Plan k8s
      working-directory: ${{ env.TF_K8S_DIR}} 
      run: terraform plan    
